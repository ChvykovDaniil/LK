<!doctype html>
<html lang="ru" data-theme="auto">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Личный кабинет студента</title>
  <meta name="color-scheme" content="light dark">
  <meta name="theme-color" content="#0ea5e9">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: 240 5% 96%;
      --surface: 0 0% 100%;
      --text: 224 71% 4%;
      --muted: 215 16% 47%;
      --border: 220 13% 91%;
      --primary: 199 89% 48%;
      --primary-600: 199 89% 42%;
      --success: 142 76% 36%;
      --danger: 0 74% 42%;
      --card-blur: 12px;
      --shadow: 0 10px 30px rgba(2, 6, 23, 0.06);
      --radius: 16px;
    }
    @media (prefers-color-scheme: dark) {
      :root {
        --bg: 222 47% 7%;
        --surface: 222 44% 13%;
        --text: 210 40% 98%;
        --muted: 215 20% 65%;
        --border: 215 28% 25%;
        --primary: 199 89% 58%;
        --primary-600: 199 89% 52%;
        --shadow: 0 10px 30px rgba(0,0,0,0.35);
      }
    }
    [data-theme="light"] {
      --bg: 240 5% 96%; --surface: 0 0% 100%; --text: 224 71% 4%; --muted: 215 16% 47%;
      --border: 220 13% 91%; --primary: 199 89% 48%; --primary-600: 199 89% 42%;
      --success: 142 76% 36%; --danger: 0 74% 42%; --card-blur: 12px; --shadow: 0 10px 30px rgba(2, 6, 23, 0.06);
    }
    [data-theme="dark"] {
      --bg: 222 47% 7%; --surface: 222 44% 13%; --text: 210 40% 98%; --muted: 215 20% 65%;
      --border: 215 28% 25%; --primary: 199 89% 58%; --primary-600: 199 89% 52%;
      --success: 142 70% 45%; --danger: 0 70% 55%; --card-blur: 14px; --shadow: 0 10px 30px rgba(0,0,0,0.35);
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      color: hsl(var(--text));
      background:
        radial-gradient(1200px 600px at 10% -20%, hsl(199 89% 85% / .4), transparent 60%),
        radial-gradient(1000px 500px at 120% 10%, hsl(259 94% 90% / .35), transparent 60%),
        linear-gradient(180deg, hsl(var(--bg)) 0%, hsl(var(--bg)) 100%);
      background-attachment: fixed;
    }
    .container { max-width: 1100px; margin: 40px auto; padding: 0 20px; }
    header.top {
      display: flex; justify-content: space-between; align-items: center; gap: 12px;
      background: hsl(var(--surface) / .7);
      backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
      border: 1px solid hsl(var(--border)); box-shadow: var(--shadow);
      border-radius: 20px; padding: 14px 16px; position: sticky; top: 14px; z-index: 5;
    }
    .brand { display: flex; align-items: center; gap: 12px; }
    .brand-logo {
      width: 36px; height: 36px; border-radius: 10px; display: grid; place-items: center;
      background: linear-gradient(135deg, hsl(var(--primary) / .18), hsl(259 94% 70% / .18));
      border: 1px solid hsl(var(--border));
    }
    .brand h1 { font-size: 18px; margin: 0; }
    .meta { color: hsl(var(--muted)); font-size: 13px; }
    .controls { display: flex; align-items: center; gap: 10px; }
    .btn {
      display: inline-flex; align-items: center; gap: 8px;
      padding: 8px 12px; border-radius: 12px; font-weight: 600; font-size: 14px;
      border: 1px solid hsl(var(--border)); background: hsl(var(--surface) / .8); color: hsl(var(--text));
      backdrop-filter: blur(10px); transition: transform .06s ease, background .2s ease, border-color .2s ease;
    }
    .btn:hover { transform: translateY(-1px); border-color: hsl(var(--primary) / .5); }
    .btn.primary {
      background: linear-gradient(135deg, hsl(var(--primary) / .18), hsl(259 94% 70% / .18));
      border-color: hsl(var(--primary) / .35);
    }
    .grid { display: grid; gap: 18px; grid-template-columns: 1.2fr .8fr; }
    @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }
    .card {
      background: hsl(var(--surface) / .75); backdrop-filter: blur(var(--card-blur)); -webkit-backdrop-filter: blur(var(--card-blur));
      border: 1px solid hsl(var(--border)); border-radius: var(--radius); box-shadow: var(--shadow); padding: 18px;
    }
    .card h2 { margin: 0 0 12px 0; font-size: 18px; }
    .info-grid { display: grid; gap: 10px; }
    .row { display: grid; gap: 10px; align-items: center; grid-template-columns: 220px 1fr; padding: 10px 0; border-bottom: 1px solid hsl(var(--border)); }
    .row:last-child { border-bottom: none; }
    .row .label { color: hsl(var(--muted)); display: flex; align-items: center; gap: 10px; }
    .icon { width: 18px; height: 18px; display: inline-block; color: hsl(var(--primary-600)); }
    .kpis { display: grid; gap: 12px; grid-template-columns: repeat(3, 1fr); }
    @media (max-width: 520px) { .kpis { grid-template-columns: 1fr; } }
    .kpi { padding: 14px; border-radius: 14px; border: 1px dashed hsl(var(--border)); background: hsl(var(--surface) / .65); }
    .kpi .label { color: hsl(var(--muted)); font-size: 13px; }
    .kpi .value { font-size: 22px; font-weight: 700; margin-top: 4px; }
    .badge { display: inline-flex; align-items: center; gap: 6px; font-size: 12px; font-weight: 600; padding: 4px 10px; border-radius: 999px; border: 1px solid hsl(var(--border)); background: hsl(var(--surface) / .6); }
    .badge.open { color: hsl(var(--danger)); border-color: hsl(var(--danger) / .25); background: hsl(var(--danger) / .06); }
    .badge.closed { color: hsl(var(--success)); border-color: hsl(var(--success) / .25); background: hsl(var(--success) / .07); }
    .fade-in { animation: fade .35s ease both; }
    @keyframes fade { from { opacity: 0; transform: translateY(2px); } to { opacity: 1; transform: translateY(0); } }
    /* Modal */
    .modal {
      position: fixed; inset: 0; display: none; place-items: center; background: rgba(0,0,0,.35);
      backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px); z-index: 50; padding: 20px;
    }
    .modal.show { display: grid; }
    .modal-card {
      width: 100%; max-width: 900px; max-height: 80vh; overflow: auto;
      background: hsl(var(--surface)); border: 1px solid hsl(var(--border));
      border-radius: 18px; box-shadow: var(--shadow); padding: 16px;
    }
    .modal-head { display: flex; justify-content: space-between; align-items: center; gap: 12px; padding-bottom: 8px; border-bottom: 1px solid hsl(var(--border)); position: sticky; top: 0; background: hsl(var(--surface)); }
    .close { border: 1px solid hsl(var(--border)); background: hsl(var(--surface)); border-radius: 10px; padding: 6px 10px; cursor: pointer; }
    .table { width: 100%; border-collapse: collapse; }
    .table th, .table td { padding: 10px; border-bottom: 1px solid hsl(var(--border)); text-align: left; }
    .table th { font-size: 12px; color: hsl(var(--muted)); font-weight: 600; letter-spacing: .02em; text-transform: uppercase; }
    .debt-type { font-weight: 600; }
    @media (max-width: 640px) {
      .row { grid-template-columns: 1fr; }
      .table th:nth-child(3), .table td:nth-child(3) { display: none; } /* скрыть колонку "Часть" на мобильных */
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="top">
      <div class="brand">
        <div class="brand-logo" aria-hidden="true">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
            <path d="M12 3l7.5 4.33v9.34L12 21l-7.5-4.33V7.33L12 3z" stroke="currentColor" stroke-width="1.6" fill="none"></path>
            <circle cx="12" cy="12" r="2.8" fill="currentColor" opacity=".25"></circle>
          </svg>
        </div>
        <div>
          <h1>Личный кабинет студента</h1>
          <div id="updatedAt" class="meta"></div>
        </div>
      </div>
      <div class="controls">
        <button id="themeToggle" class="btn" type="button" title="Переключить тему">
          <svg id="iconSun" class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="4"></circle><path d="M12 2v2m0 16v2M2 12h2m16 0h2M5 5l1.5 1.5M17.5 17.5L19 19M5 19l1.5-1.5M17.5 6.5L19 5"></path></svg>
          <svg id="iconMoon" class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" style="display:none"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
          <span>Тема</span>
        </button>
        <a class="btn primary" href="mailto:" id="mailBtn">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M4 4h16v16H4z"></path><path d="m22 6-10 7L2 6"></path></svg>
          Почта
        </a>
      </div>
    </header>

    <div class="grid fade-in" style="margin-top: 16px;">
      <section class="card">
        <h2>Профиль студента</h2>
        <div id="profile" class="info-grid"></div>
      </section>

      <section class="card">
        <h2>Статистика</h2>
        <div class="kpis">
          <div class="kpi"><div class="label">Открытые задолженности</div><div id="kpiOpen" class="value">–</div></div>
          <div class="kpi"><div class="label">Всего задолженностей</div><div id="kpiAll" class="value">–</div></div>
          <div class="kpi"><div class="label">Статус студента</div><div id="kpiStatus" class="value">–</div></div>
        </div>
        <div style="margin-top:12px">
          <button id="showDebtsBtn" class="btn primary" type="button">Ознакомиться с задолженностями</button>
        </div>
      </section>
    </div>

    <footer style="margin-top:16px" class="meta">
      Эта страница общедоступна. Данные берутся из файла data.json.
    </footer>
  </div>

  <!-- Modal -->
  <div id="debtsModal" class="modal" aria-hidden="true" aria-labelledby="debtsTitle" role="dialog">
    <div class="modal-card">
      <div class="modal-head">
        <h3 id="debtsTitle" style="margin:0">Подробный список задолженностей</h3>
        <button id="closeDebtsBtn" class="close" type="button">Закрыть</button>
      </div>
      <div style="padding-top:10px">
        <div id="debtsCounter" class="meta" style="margin-bottom:8px"></div>
        <table class="table" aria-describedby="debtsCounter">
          <thead>
            <tr>
              <th>Предмет</th>
              <th>Тип долга</th>
              <th>Часть</th>
              <th>Дата получения</th>
              <th>Статус</th>
            </tr>
          </thead>
          <tbody id="debtsTableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const $ = (sel) => document.querySelector(sel);

    function setTheme(mode) {
      const html = document.documentElement;
      if (mode === 'auto') {
        html.setAttribute('data-theme', window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
      } else {
        html.setAttribute('data-theme', mode);
      }
      const isDark = html.getAttribute('data-theme') === 'dark';
      $('#iconSun').style.display = isDark ? 'none' : '';
      $('#iconMoon').style.display = isDark ? '' : 'none';
      localStorage.setItem('theme', mode);
    }
    function initTheme() {
      const saved = localStorage.getItem('theme') || 'auto';
      setTheme(saved);
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
        if ((localStorage.getItem('theme') || 'auto') === 'auto') setTheme('auto');
      });
      $('#themeToggle').addEventListener('click', () => {
        const current = localStorage.getItem('theme') || 'auto';
        const next = current === 'light' ? 'dark' : current === 'dark' ? 'auto' : 'light';
        setTheme(next);
      });
    }

    const icons = {
      user: '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M20 21a8 8 0 1 0-16 0"></path><circle cx="12" cy="7" r="4"></circle></svg>',
      course: '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="m22 10-10 5-10-5 10-5 10 5Z"></path><path d="M6 12v5c2.5 1.5 6.5 1.5 9 0v-5"></path></svg>',
      group: '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="9" cy="7" r="4"></circle><path d="M17 11a4 4 0 1 0 0-8"></path><path d="M2 21a7 7 0 0 1 14 0"></path><path d="M22 21a6 6 0 0 0-9-5.33"></path></svg>',
      status: '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="10"></circle><path d="m9 12 2 2 4-4"></path></svg>',
      id: '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3" y="4" width="18" height="16" rx="2"></rect><path d="M7 8h10M7 12h4"></path></svg>',
      mail: '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3" y="5" width="18" height="14" rx="2"></rect><path d="m3 7 9 6 9-6"></path></svg>'
    };

    function ruDate(iso) {
      try { return new Date(iso).toLocaleDateString('ru-RU', { year: 'numeric', month: 'long', day: 'numeric' }); }
      catch { return iso || ''; }
    }

    function typeLabel(type) {
      return ({
        exam: 'Экзамен',
        zachet: 'Зачёт',
        coursework: 'Курсовая',
        lab: 'Лабораторная',
        control: 'Контрольная'
      })[type] || type || '—';
    }

    function renderProfile(data) {
      const statusText = data.status === 'active' ? 'активный' : 'неактивный';
      const statusBadge = `<span class="badge ${data.status === 'active' ? 'closed' : 'open'}">${statusText}</span>`;
      $('#profile').innerHTML = `
        <div class="row"><div class="label">${icons.user} ФИО</div><div><b>${data.full_name}</b></div></div>
        <div class="row"><div class="label">${icons.course} Номер курса</div><div><b>${data.course_number}</b></div></div>
        <div class="row"><div class="label">${icons.group} Номер группы</div><div><b>${data.group_number}</b></div></div>
        <div class="row"><div class="label">${icons.status} Статус студента</div><div>${statusBadge}</div></div>
        <div class="row"><div class="label">${icons.id} Личный номер</div><div><b>${data.student_number}</b></div></div>
        <div class="row"><div class="label">${icons.mail} Почта</div><div><a href="mailto:${data.email}">${data.email}</a></div></div>
      `;
      $('#kpiStatus').textContent = statusText;
      $('#mailBtn').href = `mailto:${data.email}`;
    }

    function renderKpis(debts) {
      const openCount = debts.filter(d => d.status === 'open').length;
      $('#kpiOpen').textContent = openCount;
      $('#kpiAll').textContent = debts.length;
    }

    function openModal() {
      const m = $('#debtsModal');
      m.classList.add('show');
      m.setAttribute('aria-hidden', 'false');
    }
    function closeModal() {
      const m = $('#debtsModal');
      m.classList.remove('show');
      m.setAttribute('aria-hidden', 'true');
    }

    function renderDebtsModal(debts) {
      const sorted = [...debts].sort((a, b) => {
        const da = a.received_at ? new Date(a.received_at).getTime() : 0;
        const db = b.received_at ? new Date(b.received_at).getTime() : 0;
        return db - da;
      });
      $('#debtsCounter').textContent = `Всего: ${sorted.length}`;
      const tbody = $('#debtsTableBody');
      tbody.innerHTML = sorted.map(d => `
        <tr>
          <td>${d.subject || d.title || '—'}</td>
          <td class="debt-type">${typeLabel(d.debt_type)}</td>
          <td>${d.part || '—'}</td>
          <td>${d.received_at ? ruDate(d.received_at) : '—'}</td>
          <td><span class="badge ${d.status === 'open' ? 'open' : 'closed'}">${d.status === 'open' ? 'Открыта' : 'Закрыта'}</span></td>
        </tr>
      `).join('');
    }

    async function load() {
      try {
        const res = await fetch('data.json', { cache: 'no-store' });
        if (!res.ok) throw new Error('Не удалось загрузить data.json');
        const data = await res.json();

        $('#updatedAt').textContent = 'Обновлено: ' + ruDate(new Date().toISOString());
        renderProfile(data);
        const debts = Array.isArray(data.debts) ? data.debts : [];
        renderKpis(debts);

        $('#showDebtsBtn').addEventListener('click', () => { renderDebtsModal(debts); openModal(); });
        $('#closeDebtsBtn').addEventListener('click', closeModal);
        $('#debtsModal').addEventListener('click', (e) => { if (e.target === $('#debtsModal')) closeModal(); });
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeModal(); });
      } catch (e) {
        console.error(e);
      }
    }

    initTheme();
    load();
  </script>
</body>
</html>
